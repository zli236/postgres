-- predictability
SET synchronous_commit = on;
-- turn on logical ddl message logging
CREATE publication mypub FOR ALL TABLES with (ddl = 'database');
-- SET USER
CREATE ROLE ddl_replication_user LOGIN SUPERUSER;
SET SESSION AUTHORIZATION 'ddl_replication_user';
SELECT 'init' FROM pg_create_logical_replication_slot('regression_slot', 'test_decoding');
 ?column? 
----------
 init
(1 row)

CREATE TABLE tab1 (id serial unique, data int);
ALTER TABLE tab1 add c3 varchar;
ALTER TABLE tab1 drop c3;
DROP TABLE tab1;
BEGIN;
CREATE TABLE tab1 (id serial unique, data int);
ALTER TABLE tab1 add c3 varchar;
ROLLBACK;
BEGIN;
CREATE TABLE tab1 (id serial unique, data int);
ALTER TABLE tab1 add c3 varchar;
COMMIT;
SELECT data FROM pg_logical_slot_get_changes('regression_slot', NULL, NULL, 'include-xids', '0', 'skip-empty-xacts', '1');
                                                                              data                                                                               
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
 BEGIN
 sequence public.tab1_id_seq: transactional:1 last_value: 1 log_cnt: 0 is_called:0
 DDL message: transactional: 1 prefix:  role: ddl_replication_user, search_path: "$user", public, sz: 47 content:CREATE TABLE tab1 (id serial unique, data int);
 COMMIT
 DDL message: transactional: 1 prefix:  role: ddl_replication_user, search_path: "$user", public, sz: 32 content:ALTER TABLE tab1 add c3 varchar;
 DDL message: transactional: 1 prefix:  role: ddl_replication_user, search_path: "$user", public, sz: 25 content:ALTER TABLE tab1 drop c3;
 DDL message: transactional: 1 prefix:  role: ddl_replication_user, search_path: "$user", public, sz: 16 content:DROP TABLE tab1;
 BEGIN
 sequence public.tab1_id_seq: transactional:1 last_value: 1 log_cnt: 0 is_called:0
 DDL message: transactional: 1 prefix:  role: ddl_replication_user, search_path: "$user", public, sz: 47 content:CREATE TABLE tab1 (id serial unique, data int);
 DDL message: transactional: 1 prefix:  role: ddl_replication_user, search_path: "$user", public, sz: 32 content:ALTER TABLE tab1 add c3 varchar;
 COMMIT
(12 rows)

SELECT pg_drop_replication_slot('regression_slot');
 pg_drop_replication_slot 
--------------------------
 
(1 row)

DROP TABLE tab1;
DROP publication mypub;
